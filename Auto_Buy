-- Rarity Selector GUI avec Auto Buy Logic
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local joueur = Players.LocalPlayer

-- Variables de base
local MonNomDePlot = joueur:GetAttribute("InPlot")
local MonPlot = workspace.CoreObjects.Plots:FindFirstChild(MonNomDePlot)
local Bank = joueur.leaderstats.Cash:GetAttribute("ExactValue")
local ClientUtils = require(ReplicatedStorage:WaitForChild("Client"):WaitForChild("Modules"):WaitForChild("ClientUtils"))
local rebirths = (ClientUtils.ProfileData and ClientUtils.ProfileData.leaderstats and ClientUtils.ProfileData.leaderstats.Rebirths) or 0
local Networker = ReplicatedStorage.Shared.Packages.Networker

-- Liste de toutes les raret√©s
local rarities = {
    "GOD", "Divine", "Event", "Exclusive", "Admin", 
    "Limited", "OG", "Exotic", "secret", "Mythic", 
    "Legendary", "Epic", "Rare", "Uncommon", "Common"
}

local rarityColors = {
    GOD = Color3.fromRGB(255, 0, 0),
    Divine = Color3.fromRGB(255, 170, 0),
    Event = Color3.fromRGB(255, 107, 157),
    Exclusive = Color3.fromRGB(194, 24, 91),
    Admin = Color3.fromRGB(0, 255, 0),
    Limited = Color3.fromRGB(76, 175, 80),
    OG = Color3.fromRGB(156, 39, 176),
    Exotic = Color3.fromRGB(233, 30, 99),
    secret = Color3.fromRGB(103, 58, 183),
    Mythic = Color3.fromRGB(255, 87, 34),
    Legendary = Color3.fromRGB(255, 152, 0),
    Epic = Color3.fromRGB(156, 39, 176),
    Rare = Color3.fromRGB(33, 150, 243),
    Uncommon = Color3.fromRGB(76, 175, 80),
    Common = Color3.fromRGB(158, 158, 158)
}

-- Raret√©s recherch√©es (modifiable via l'interface)
local RaretesRecherchees = {}

-- Cr√©er le ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "RaritySelector"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Protection contre la suppression
if gethui then
    screenGui.Parent = gethui()
elseif syn and syn.protect_gui then
    syn.protect_gui(screenGui)
    screenGui.Parent = game.CoreGui
else
    screenGui.Parent = game.CoreGui
end

-- Frame principale
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 300, 0, 450)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -225)
mainFrame.BackgroundColor3 = Color3.fromRGB(22, 33, 62)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = true
mainFrame.Parent = screenGui

-- Corner pour arrondir
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = mainFrame

-- Titre
local title = Instance.new("TextLabel")
title.Name = "Title"
title.Size = UDim2.new(1, 0, 0, 40)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.Text = "üéØ S√©lecteur de Raret√©"
title.TextColor3 = Color3.fromRGB(233, 69, 96)
title.TextSize = 20
title.Font = Enum.Font.GothamBold
title.Parent = mainFrame

-- ScrollingFrame pour la liste
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Name = "ScrollFrame"
scrollFrame.Size = UDim2.new(1, -20, 1, -60)
scrollFrame.Position = UDim2.new(0, 10, 0, 50)
scrollFrame.BackgroundTransparency = 1
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 6
scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(233, 69, 96)
scrollFrame.Parent = mainFrame

-- UIListLayout pour organiser les boutons
local listLayout = Instance.new("UIListLayout")
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Padding = UDim.new(0, 5)
listLayout.Parent = scrollFrame

-- Fonction pour v√©rifier si une raret√© est s√©lectionn√©e
local function EstRareteSelectionnee(rarete)
    for _, rareteRecherchee in ipairs(RaretesRecherchees) do
        if rarete == rareteRecherchee then
            return true
        end
    end
    return false
end

-- Fonction pour ajouter/retirer une raret√©
local function ToggleRarete(rarete, button, stroke)
    if EstRareteSelectionnee(rarete) then
        -- Retirer la raret√©
        for i, r in ipairs(RaretesRecherchees) do
            if r == rarete then
                table.remove(RaretesRecherchees, i)
                break
            end
        end
        button.BackgroundColor3 = Color3.fromRGB(15, 52, 96)
        stroke.Transparency = 1
    else
        -- Ajouter la raret√©
        table.insert(RaretesRecherchees, rarete)
        button.BackgroundColor3 = Color3.fromRGB(45, 74, 111)
        stroke.Color = Color3.fromRGB(233, 69, 96)
        stroke.Transparency = 0
    end
    
    print("Raret√©s recherch√©es:", table.concat(RaretesRecherchees, ", "))
end

-- Fonction pour cr√©er un bouton de raret√©
local function createRarityButton(rarity, index)
    local button = Instance.new("TextButton")
    button.Name = rarity
    button.Size = UDim2.new(1, -10, 0, 35)
    button.BackgroundColor3 = Color3.fromRGB(15, 52, 96)
    button.BorderSizePixel = 0
    button.Text = rarity
    button.TextColor3 = rarityColors[rarity] or Color3.fromRGB(255, 255, 255)
    button.TextSize = 16
    button.Font = Enum.Font.GothamSemibold
    button.LayoutOrder = index
    button.Parent = scrollFrame
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 8)
    buttonCorner.Parent = button
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(15, 52, 96)
    stroke.Thickness = 2
    stroke.Transparency = 1
    stroke.Parent = button
    
    -- Effet hover
    button.MouseEnter:Connect(function()
        if not EstRareteSelectionnee(rarity) then
            button.BackgroundColor3 = Color3.fromRGB(26, 77, 122)
        end
    end)
    
    button.MouseLeave:Connect(function()
        if not EstRareteSelectionnee(rarity) then
            button.BackgroundColor3 = Color3.fromRGB(15, 52, 96)
        end
    end)
    
    -- Toggle s√©lection
    button.MouseButton1Click:Connect(function()
        ToggleRarete(rarity, button, stroke)
    end)
    
    return button
end

-- Cr√©er tous les boutons
for i, rarity in ipairs(rarities) do
    createRarityButton(rarity, i)
end

-- Calculer la taille du contenu
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, (#rarities * 40))

-- Fonction pour r√©cup√©rer les raret√©s s√©lectionn√©es
getgenv().GetSelectedRarities = function()
    return RaretesRecherchees
end

print("Rarity Selector charg√© ! S√©lectionnez vos raret√©s.")

-- ========== LOGIQUE AUTO BUY ==========

local function GetConvoyeurInfo()
    local EggFolder = workspace.CoreObjects.Eggs
    for _, model in ipairs(EggFolder:GetChildren()) do
        if model:GetAttribute("CurrentEgg") then
            for _, meshFolder in ipairs(model:GetChildren()) do
                if meshFolder.Name:match("^Meshes/") then
                    local billboard = meshFolder:FindFirstChild("BillboardAttachment")
                    if billboard then
                        local eggBillboard = billboard:FindFirstChild("EggBillboard")
                        if eggBillboard then
                            local EggFrame = eggBillboard:FindFirstChild("Frame")
                            if EggFrame then 
                                local Rarity = EggFrame:FindFirstChild("Rarity")
                                if Rarity and Rarity:IsA("TextLabel") then
                                    return Rarity.Text, model.Name
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    return nil, nil
end

local function EstRareteRecherchee(rarete)
    for _, rareteRecherchee in ipairs(RaretesRecherchees) do
        if rarete == rareteRecherchee then
            return true
        end
    end
    return false
end

local function TrouverRareteAvecRetry(brainrotName, maxTentatives)
    maxTentatives = maxTentatives or 3
    for tentative = 1, maxTentatives do
        local rarityText, _ = GetConvoyeurInfo()
        if rarityText then 
            return rarityText
        else
            if tentative < maxTentatives then
                wait(0.2) 
            end
        end
    end
    warn("‚ö†Ô∏è Impossible de trouver la raret√© apr√®s", maxTentatives, "tentatives")
    return nil
end

local function AutoBuyEgg()
    while true do
        wait(0.1) 
        local rarityText, brainrotName = GetConvoyeurInfo()
        if brainrotName then
            if not rarityText then
                rarityText = TrouverRareteAvecRetry(brainrotName, 3)
            end
            if rarityText then   
                if EstRareteRecherchee(rarityText) then
                    print(brainrotName, rarityText)
                    print(Bank)
                    Networker["RF/BuyEgg"]:InvokeServer(brainrotName, 1)
                    Networker["RF/BuyEgg"]:InvokeServer(brainrotName, 1)
                    Networker["RF/BuyEgg"]:InvokeServer(brainrotName, 1)
                    print(Bank)
                    Networker["RF/RequestEggSpawn"]:InvokeServer()
                    wait(0.2)
                else               
                    Networker["RF/RequestEggSpawn"]:InvokeServer()
                end
            else
                Networker["RF/RequestEggSpawn"]:InvokeServer()
            end
        else
            Networker["RF/RequestEggSpawn"]:InvokeServer()
        end
    end
end

-- Lancer l'auto buy
AutoBuyEgg()